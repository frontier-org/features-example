# Copyright (c) 2026 The Frontier Framework Authors
# SPDX-License-Identifier: Apache-2.0 OR MIT

name: Build Windows Frontier App Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-windows-release:
    runs-on: windows-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: main

      # --- Install Dependencies ---

      - name: Cache MinGW (GCC)
        id: cache-mingw
        uses: actions/cache@v4
        with:
          path: C:\ProgramData\chocolatey\lib\mingw
          key: ${{ runner.os }}-mingw-v1
          restore-keys: ${{ runner.os }}-mingw-

      - name: Set up MinGW (GCC)
        if: steps.cache-mingw.outputs.cache-hit != 'true'
        run: |
          choco install mingw --unattended
          echo "C:\tools\mingw64\bin" >> $env:GITHUB_PATH

      # --- Install Rust ---
      
      - name: Cache Rust
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-v1
          restore-keys: ${{ runner.os }}-cargo-

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      # --- Install Frontier ---

      - name: Cache Frontier
        uses: actions/cache@v4
        with:
          path: |
            .frontier/target/debug/
            .frontier/target/release/
          key: ${{ runner.os }}-frontier-${{ hashFiles('.frontier/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-frontier-

      - name: Install Frontier
        shell: pwsh
        run: $v='0.1.0-alpha.6'; $p='.'; $ni=$true; $nu=$true; iex(irm https://frontier-fw.dev/get.ps1)

      # --- Build Process ---

      - name: Build Frontier App
        run: .\frontier build

      - name: Extract App Information
        id: get_app_info
        shell: pwsh
        run: |
          $appName = "MyApp"
          if (Test-Path frontier.toml) {
              $toml = Get-Content frontier.toml -Raw
              if ($toml -match '(?ms)\[app\].*?name\s*=\s*"(?<name>[^"]+)"') {
                  $appName = $Matches['name']
              }
          }
          echo "APP_NAME=$appName" >> $env:GITHUB_ENV
          echo "APP_PATH=./dist/$appName.exe" >> $env:GITHUB_ENV

      # --- Release ---

      - name: Create Release and Upload File
        uses: softprops/action-gh-release@v2
        with:
          name: "${{ github.repository }} - ${{ github.ref_name }}"
          generate_release_notes: true
          files: ${{ env.APP_PATH }}
          prerelease: ${{ contains(github.ref_name, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
